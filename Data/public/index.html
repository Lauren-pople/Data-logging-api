<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>How i slept</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>

    <div class="stars"></div>
    <div class="twinkling"></div>
   

<!-- <section>-->
  <div id ="slider">
    <h1>How I slept</h1>

    <p><label for="happiness">How did i sleep on a scale from 1-10?</label> <br>
    <input type="range" id="happiness" min="1" max="10" value="5" oninput="sliderChange(this.value)">
    <output id="sliderVal"> </output> <br>
    <button id="submit">submit</button>
          </p>
   
    <p>
      <div class="canvasContainer">

    <canvas id="chart" ></canvas>
  </div>
  </p>

    <script>


      let xVals = [];
      let yVals = [];


      function sliderChange(val) {
          document.getElementById('sliderVal').innerHTML = val;
      }

      const buttonSubmit = document.getElementById('submit');
      
      buttonSubmit.addEventListener('click', async event => {
        const sleep = document.getElementById('happiness').value;

        const data = {sleep};
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        };
        const response = await fetch('/api', options);
        const json = await response.json();
        console.log(json);

        chartIt();
      
      });


  chartIt();

async function chartIt() {
    const response = await fetch('/api');
    const data = await response.json();


  console.log(data);

    let day = 86400000; //ms in a day
    let begin= 1571270400000;
    let end = begin + day;
    let dayNumber = 1;
    let j = 0;

    for (let i = 0; i < data.length; i++){
     // console.log (data[i].timestamp + "  " +new Date(data[i].timestamp).toLocaleString());
      //console.log (end + " end " + new Date(end).toLocaleString());
      //console.log (end - data[i].timestamp );
      
      if (data[i].timestamp > begin && data[i].timestamp < end ){
       // console.log(data[i].timestamp + " day" + dayNumber);
        begin += day;
        end += day;
        xVals[j] = new Date(data[i].timestamp).toLocaleString();
       // console.log(xVals[j]);
        yVals[j] = data[i].sleep;
       // console.log("y",yVals[j]); 
       // console.log ( new Date(data[i].timestamp).toLocaleString( ) + " day " + dayNumber);
        dayNumber ++;
        j++;
      }
    //  console.log(xVals);
    }
    
    const ctx = document.getElementById('chart').getContext('2d');
    const myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: xVals,
        datasets: [{
            label: 'sleep over time',
            data: yVals,
            fill: false,
            backgroundColor: 'rgba(38, 12, 12)',
            borderColor: 'rgba(255, 255, 255)',
            borderWidth: 1}]
              },
            options: {  
              legend: {
                display: false,
              },
              tooltips:{
                enabled:true,
                backgroundColor:'#000000',
              },
                scales: {
                    xAxes: [{
                         gridLines: {
                           drawBorder: true,
                            display: false,

                         },
                         ticks: {
                            display: false,
                          }

                    }],
                      yAxes: [{
                         gridLines: {
                            display: false,

                         },
                         
                    }],
                     ticks: {
                    fontSize: 15,
                    fontColor: 'lightgrey',
                    
                  }

                }
            }
        });

      }
    </script>
  </body>
</html>
